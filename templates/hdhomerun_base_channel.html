{% extends "base.html" %}
{% block content %}
<div>
  <div class='form-inline input-group' style="padding-top: 0px; padding-bottom:0px; align-items: left;">
    <div class="btn-group btn-group-sm flex-wrap mr-2" role="group">
      <button id="load_data_btn" class="btn btn-sm btn-outline-primary">데이터 파일에서 읽기</button>
      <button id="epg_channel_btn" class="btn btn-sm btn-outline-primary">EPG  채널 목록</button>
      <button id="auto_epg_match_btn" class="btn btn-sm btn-outline-primary">전체 EPG 채널 매치</button>
      <button id="auto_channel_number_btn" class="btn btn-sm btn-outline-primary">현재 순서대로 채널 번호 부여</button>
      <button id="group_sort_btn" class="btn btn-sm btn-outline-primary">그룹별 정렬</button>
      <button id="save_btn" class="btn btn-sm btn-outline-primary">저장</button>
    </div>
    <div class="input-group col-sm-3" style="padding-left:0px; padding-top:0px">
      <select id="view_mode" name="view_mode" class="form-control form-control-sm">
        <option value="all">전체 채널</option>
        <option value="no_epg">사용중 채널 중 EPG 매칭 안 된 채널</option>
        <option value="use">사용 채널</option>
        <option value="use_false">미사용 채널</option>
      </select>
    </div>
  </div>

  {{ macros.m_hr_head_top() }}
  {{ macros.m_row_start('0') }}
  {{ macros.m_col(2,  macros.m_strong('설정 / VID')) }}
  {{ macros.m_col(1,  macros.m_strong('번호')) }}
  {{ macros.m_col(2,  macros.m_strong('이름(화면)')) }}
  {{ macros.m_col(2,  macros.m_strong('EPG검색')) }}
  {{ macros.m_col_wide(1,  macros.m_strong('EPG')) }}
  {{ macros.m_col_wide(1,  macros.m_strong('Group')) }}
  {{ macros.m_col(3,  macros.m_strong('Action'), 'center') }}
  {{ macros.m_row_end() }}
  {{ macros.m_hr_head_bottom() }}
  <form id="custom_form" name="custom_form">
  <div id="list_div"></div>
  </form>
</div>

<form name="playform">
  <input type="hidden" id="play_title" name="play_title">
  <input type="hidden" id="play_source_src"  name="play_source_src">
  <input type="hidden" id="play_source_type"  name="play_source_type">
</form>


<script type="text/javascript">
var ddns = "{{ arg['ddns'] }}";
var apikey = "{{ arg['apikey'] }}";
$(document).ready(function(){
  load_db();
});

$("body").on('click', '#load_data_btn', function(e){
  e.preventDefault();
  document.getElementById("confirm_title").innerHTML = "데이터 로드";
  document.getElementById("confirm_body").innerHTML = "데이터 로드시 기존 채널 정보는 모두 초기화됩니다.<br>진행 하시겠습니까?";
  $('#confirm_button').attr('onclick', "load_data();");
  $("#confirm_modal").modal();
  return;
});

function load_db() {
  globalSendCommand('load_db', null, null, null, function(data) {
    current_data = data;
    make_list();
  });
}

function load_data() {
  globalSendCommand('load_data', null, null, null, function(data) {
    load_db();
  });
}

$("body").on('change', '#view_mode', function(e){
  e.preventDefault();
  make_list()
});

$("body").on('click', '#epg_channel_btn', function(e){
  e.preventDefault();
  globalSendCommand('epg_channel_list');
});

$("body").on('click', '#auto_epg_match_btn', function(e){
  e.preventDefault();
  globalSendCommand('auto_epg_match');
});

$("body").on('click', '#match_for_epg_name_btn', function(e){
  e.preventDefault();
  index = $(this).data('index')
  id = $(this).data('id')
  for_epg_name = document.getElementById("for_epg_name|"+id).value

  globalSendCommand('match_for_epg_name', id, for_epg_name, null, function(data){
    if (data.ret == 'success') {
      console.log(data)
      data = data.ch;
      current_data.data[index].match_epg_name = data.match_epg_name
      current_data.data[index].group_name = data.group_name
      document.getElementById("match_epg_name|"+id).value = data.match_epg_name
      document.getElementById("group_name|"+id).value = data.group_name
    } 
  });
});

$("body").on('click', '#clipboard_copy_btn', function(e){
  e.preventDefault();
  var copyText = $(this).data('url')
  var tempElem = document.createElement('textarea');
  tempElem.value = copyText;
  document.body.appendChild(tempElem);
  tempElem.select();
  document.execCommand("copy");
  document.body.removeChild(tempElem);
  $.notify('<strong>주소를 클립보드에 복사하였습니다.</strong>', {
    type: 'success'
  });
});

$("body").on('click', '#delete_btn', function(e){
  e.preventDefault();
  globalSendCommand('delete', $(this).data('id'), null, null, function(data) {
    if (data.ret == 'success') {
      current_data = data
      make_list()
    }
  });
});

$("body").on('click', '#auto_channel_number_btn', function(e){
  e.preventDefault();
  data = current_data.data
  no = 1
  for(i in data) {
    data[i].ch_number = no
    no += 1
  }
  make_list()
  $.notify('<strong>작업완료</strong>', {
    type: 'success'
  });
});


$("body").on('click', '#up_btn', function(e){
  e.preventDefault();
  target_id = $(this).data('index')
  target = current_data.data[target_id]
  if (target_id != 0) {
    current_data.data.splice(target_id, 1);
    current_data.data.splice(target_id-1, 0, target);
  }
  make_list()
});


$("body").on('click', '#down_btn', function(e){
  e.preventDefault();
  target_id = $(this).data('index')
  target = current_data.data[target_id]
  if (current_data.data.length -1 != target_id) {
    current_data.data.splice(target_id, 1);
    current_data.data.splice(target_id+1, 0, target);
  }
  make_list()
});


$("body").on('click', '#save_btn', function(e){
  e.preventDefault();
  var formData = getFormdata('#custom_form');
  globalSendCommand('save', formData, null, null, function(data) {
    if (data.ret == 'success') {
      current_data = data;
      make_list()
    }
  });
});


$("body").on('click', '#group_sort_btn', function(e){
  e.preventDefault();
  globalSendCommand('group_sort', null, null, null, function(data) {
    if (data.ret == 'success') {
      current_data = data;
      make_list()
    }
  });
});


$("body").on('click', '#web_play_btn', function(e) {
  e.preventDefault();
  id = $(this).data('id');
  name = $(this).data('name');
  url = $(this).data('url');

  video_id = "hdhomerun_"+name+"_"+id
  url = ddns + "/hdhomerun/api/trans.ts?source=" + url;
  if (true) {
    url = url + '&apikey=' + apikey
  } 

  error_count = 0
  //play_video(video_id, url, true)

  var form = document.playform;
  var popupWidth = 980;
  var leftPos = screen.width - popupWidth;
  var target = video_id;
  window.open('', target, "location=no, directories=no,resizable=no,status=no,toolbar=no,menubar=no,width=" + popupWidth + ", height=560, top=100, left=" + leftPos);
  
  form.action = '/hdhomerun/video';
  form.method = "post";
  form.target = target;

  $('#play_title').val(name);
  $('#play_source_src').val(url);
  $('#play_source_type').val('application/x-mpegURL');
  form.submit();
});

$("body").on('click', '#program_btn', function(e){
  e.preventDefault();
  globalSendCommand('program', $(this).data('id'));
});





























function make_list() {
  console.log(current_data)
  str = '';
  data = current_data.data
  var current_view_mode = $("#view_mode").val();
  for (i in data) {
    if (current_view_mode == 'use') {
      if (data[i].use == false) continue
    } else if (current_view_mode == 'use_false') {
      if (data[i].use) continue
    } else if (current_view_mode == 'no_epg') {
      if (data[i].use == false) continue
      if (data[i].match_epg_name != '') continue
    }
    str += j_row_start(5);

    tmp2 = ((data[i].use) ? "checked" : "");
    tmp = '<input id="use_checkbox|'+data[i].id+'" name="use_checkbox|'+data[i].id+'" type="checkbox" data-toggle="toggle" data-on="사용" data-off="-" data-onstyle="info" data-offstyle="danger" data-size="small" '+tmp2+'>&nbsp;&nbsp;'
    tmp2 = ((data[i].use_vid) ? "checked" : "");
    tmp += '<input id="use_vid_checkbox|'+data[i].id+'" name="use_vid_checkbox|'+data[i].id+'" type="checkbox" data-toggle="toggle" data-on="vid" data-off=".mpeg" data-onstyle="danger" data-offstyle="info" data-size="small" '+tmp2+'>&nbsp;&nbsp;'
    tmp +=  data[i].scan_vid
    str += j_col(2, tmp);

    tmp = '<input id="ch_number|'+data[i].id+'" name="ch_number|'+data[i].id +'"  class="form-control form-control-sm w-100" min="1" type="number" value="'+ data[i].ch_number +'">'
    str += j_col(1, tmp);

    tmp = '<input id="scan_name|'+data[i].id+'" name="scan_name|'+data[i].id +'"  class="form-control form-control-sm w-100" type="text" value="'+ data[i].scan_name +'">'
    str += j_col(2, tmp)

    tmp = '<input id="for_epg_name|'+data[i].id+'" name="for_epg_name|'+data[i].id +'"  class="form-control form-control-sm w-100" type="text" value="'+ data[i].for_epg_name +'">'
    str += j_col(2, tmp, 'center')

    if (data[i].match_epg_name=='') {
      tmp = '[NO EPG]'
    } else {
      tmp = data[i].match_epg_name
    }
    tmp = '<input id="match_epg_name|'+data[i].id+'" name="match_epg_name|'+data[i].id +'"  class="form-control form-control-sm w-100" type="text" value="'+ tmp +'" disabled>'
    str += j_col_wide(1, tmp, 'center')

    tmp = '<input id="group_name|'+data[i].id+'" name="group_name|'+data[i].id +'"  class="form-control form-control-sm w-100" type="text" value="'+ data[i].group_name +'">'
    str += j_col_wide(1, tmp, 'center')
    
    tmp = ''
    tmp += j_button('match_for_epg_name_btn', 'EPG 찾기', {'index':i, 'id':data[i].id});
    tmp += j_button('delete_btn', '삭제', {'id':data[i].id});
    tmp += j_button('up_btn', '⬆️', {'index':i});
    tmp += j_button('down_btn', '⬇️', {'index':i});

    tmp = j_button_group(tmp)
    str += j_col(3, tmp, 'right')
    str += j_row_end();
    if (i != data.length -1) str += j_hr(0);
  }
  document.getElementById("list_div").innerHTML = str;
  $('input[id^="use_checkbox|"]').bootstrapToggle()
  $('input[id^="use_vid_checkbox|"]').bootstrapToggle()
}
</script>    
{% endblock %}